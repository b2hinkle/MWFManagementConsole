@page "/Games"
@inject HttpClient Http
@using System.Text.Json



<CardBody>
    <Row>
        <Column>
            <h3>Game Instances</h3>
            <Fields>
                <Field>
                    <FieldBody>
                        <Inline>
                            <Button Color="Color.Primary" Clicked="@ReloadTable" Disabled="RefreshButtonDisabed" Loading="RefreshButtonDisabed"> Refresh</Button>
                            <TextEdit @bind-Text="@customFilterValue" Placeholder="Search" />
                        </Inline>
                    </FieldBody>
                </Field>
            </Fields>
            <DataGrid TItem="GameInstanceModel"
                      @ref="dataGrid"
                      Data="@dataModels"
                      SortMode="DataGridSortMode.Multiple"
                      Striped="true"
                      Bordered="true"
                      Hoverable="true"
                      Filterable="true"
                      PageSize="@pageSize"
                      ShowPager="@true"
                      SelectedRowChanged="@OnSelectedRowChanged"
                      CustomFilter="@OnCustomFilter">
                <EmptyTemplate>No records...</EmptyTemplate>
                <DataGridColumns>
                    <DataGridColumn TItem="GameInstanceModel" Field="@nameof(GameInstanceModel.Id)" Caption="Id" Editable="true">
                        <FilterTemplate>
                            <TextEdit Placeholder="Search by Id" Text="@context.SearchValue" TextChanged="@(v => context.TriggerFilterChange(v))" />
                        </FilterTemplate>
                    </DataGridColumn>
                    <DataGridColumn TItem="GameInstanceModel" Field="@nameof(GameInstanceModel.Game)" Caption="Game" Editable="true">
                        <CaptionTemplate>
                            <Icon Name="IconName.Gamepad" /> @context.Caption
                        </CaptionTemplate>
                        <FilterTemplate>
                            @{
                                var selectedValue = @context.SearchValue ?? "*";
                                <Select TValue="string" SelectedValue="@selectedValue" SelectedValueChanged="@(e => context.TriggerFilterChange(e == "*" ? "" : e.ToString()))">
                                    <SelectItem Value="@("*")">All</SelectItem>
                                    @foreach (string item in searchableGames)
                                    {
                                        <SelectItem Value="@item">@item</SelectItem>
                                    }
                                </Select>
                            }
                        </FilterTemplate>
                    </DataGridColumn>
                    <DataGridColumn TItem="GameInstanceModel" Field="@nameof(GameInstanceModel.Port)" Caption="Port" Editable="true" PopupFieldColumnSize="ColumnSize.IsFull.OnDesktop">
                        <CaptionTemplate>
                            <Icon Name="IconName.Circle" /> @context.Caption
                        </CaptionTemplate>
                        <FilterTemplate>
                            <TextEdit Placeholder="Search by Port" Text="@context.SearchValue" TextChanged="@(v => context.TriggerFilterChange(v))" />
                        </FilterTemplate>
                    </DataGridColumn>
                    <DataGridColumn TItem="GameInstanceModel" Field="@nameof(GameInstanceModel.Args)" Caption="Args" Editable="true">
                        <CaptionTemplate>
                            <Icon Name="IconName.GripLines" /> @context.Caption
                        </CaptionTemplate>
                        <FilterTemplate>
                            <TextEdit Placeholder="Search by Args" Text="@context.SearchValue" TextChanged="@(v => context.TriggerFilterChange(v))" />
                        </FilterTemplate>
                    </DataGridColumn>
                </DataGridColumns>
            </DataGrid>
                <Button Color="Color.Danger" Clicked="@(dataGrid?.SelectedRow != null ? removeWindowRef.Show : null)" Disabled="(dataGrid?.SelectedRow == null || isDeleting)" Loading="isDeleting" Size="Size.Small"> Delete Selected</Button>
        </Column>
    </Row>
</CardBody>


<Modal @ref="removeWindowRef">
    <ModalContent>
        <ModalBody>
            You are about to shut down this game server and remove it from the database. Would you like to proceed?
        </ModalBody>
        <ModalFooter>
            <Button Loading="isDeleting" Disabled="isDeleting" Color="Color.Danger" Clicked="@ShutDownAndRemove"> Shutdown and remove</Button>
        </ModalFooter>
    </ModalContent>
</Modal>


<Card>
    <CardHeader>
        <CardTitle>Create New Game Instance</CardTitle>
    </CardHeader>
    <CardBody>
        @*Non Blazorise form*@
        <EditForm EditContext="AddGIFormContext" OnValidSubmit="CreateNewGameInstance">
            <div class="form-group">
                <label>Game</label>
                <InputSelect @bind-Value="NewGameInstanceToAdd.Game" class="form-control">
                    @foreach (var game in Enum.GetValues(typeof(MWFModelsLibrary.Enums.Game)))
                    {
                        <option>@game.ToString()</option>
                    }
                </InputSelect>
            </div>
            <div class="form-group">
                <label>Port</label>
                <InputText @bind-Value="NewGameInstanceToAdd.Port" class="form-control" />
            </div>
            <div class="form-group">
                <label>Args</label>
                <InputText @bind-Value="NewGameInstanceToAdd.Args" class="form-control" />
            </div>
            <div class="form-group">
                <label>HostId</label>
                <InputNumber @bind-Value="NewGameInstanceToAdd.HostId" class="form-control" />
            </div>
            <button type="submit" class="btn btn-primary" disabled=@isSubmitting>Create</button>
        </EditForm>

    </CardBody>
</Card>



<Snackbar @ref="snackbarGICreated" Color="SnackbarColor.Success">
    <SnackbarBody>
        New game instance created successfully!
        <SnackbarAction Clicked="@(() => snackbarGICreated.Hide())">CLOSE</SnackbarAction>
    </SnackbarBody>
</Snackbar>
<Snackbar @ref="snackbarGINotCreated" Color="SnackbarColor.Danger">
    <SnackbarBody>
        Failed to create new game instance
        <SnackbarAction Clicked="@(() => snackbarGINotCreated.Hide())">CLOSE</SnackbarAction>
    </SnackbarBody>
</Snackbar>


@code
{
    EditContext AddGIFormContext { get; set; }
    Modal removeWindowRef;

    int pageSize = 50;
    bool isSubmitting;
    bool RefreshButtonDisabed;
    bool isDeleting;
    Snackbar snackbarGICreated;
    Snackbar snackbarGINotCreated;

    DataGrid<GameInstanceModel> dataGrid;
    List<GameInstanceModel> dataModels;
    List<string> searchableGames = new List<string>();
    GameInstanceModel NewGameInstanceToAdd = new GameInstanceModel();

    protected override async Task OnInitializedAsync()
    {
        // Set the form edit context with your model. 
        AddGIFormContext = new EditContext(NewGameInstanceToAdd);
        await ReloadTable();
    }

    string customFilterValue;
    bool OnCustomFilter(GameInstanceModel model)
    {
        if (string.IsNullOrEmpty(customFilterValue))
            return true;

        return
            model.Id.ToString()?.Contains(customFilterValue, StringComparison.OrdinalIgnoreCase) == true
            || model.Game.ToString()?.Contains(customFilterValue, StringComparison.OrdinalIgnoreCase) == true
            || model.Args.ToString()?.Contains(customFilterValue, StringComparison.OrdinalIgnoreCase) == true
            || model.Port?.Contains(customFilterValue, StringComparison.OrdinalIgnoreCase) == true;
    }

    void OnSelectedRowChanged()
    {
        StateHasChanged();
    }

    async Task ShutDownAndRemove()
    {
        isDeleting = true;
        var result = await Http.PostAsJsonAsync<int>(@"http://localhost:7071/api/DeleteGameInstanceById", dataGrid.SelectedRow.Id, new JsonSerializerOptions() { PropertyNameCaseInsensitive = true });
        await dataGrid.SelectRow(null);
        await ReloadTable();
        removeWindowRef.Hide();
        isDeleting = false;
    }

    async Task CreateNewGameInstance()
    {
        snackbarGICreated.Hide();
        snackbarGINotCreated.Hide();
        isSubmitting = true;
        var result = await Http.PostAsJsonAsync<GameInstanceModel>(@"http://localhost:7071/api/CreateGameInstanceAndReturnId", (GameInstanceModel)AddGIFormContext.Model, new JsonSerializerOptions() { PropertyNameCaseInsensitive = true });
        isSubmitting = false;
        if (result.IsSuccessStatusCode)
        {
            snackbarGICreated.Show();
            await ReloadTable();    // Fetch the new table data and display it
        }
        else
        {
            snackbarGINotCreated.Show();
        }

        // Refresh the Editcontext so validator outlines go away
        AddGIFormContext = new EditContext(NewGameInstanceToAdd);
    }

    async Task ReloadTable()
    {
        RefreshButtonDisabed = true;
        // Update our GameInstances list
        IEnumerable<GameInstanceModel> response = await Http.GetFromJsonAsync<IEnumerable<GameInstanceModel>>(@"http://localhost:7071/api/GetGameInstances");
        dataModels = new List<GameInstanceModel>(response);


        // Make sure we have all the games that are currently running. This list is used for the filter dropdown
        searchableGames.Clear();
        foreach (GameInstanceModel item in dataModels)
        {
            string gameName = item.Game.ToString();
            if (searchableGames.Contains(gameName) == false)
            {
                searchableGames.Add(gameName);
            }
        }


        // always call StateHasChanged!
        StateHasChanged();
        RefreshButtonDisabed = false;
    }

}

